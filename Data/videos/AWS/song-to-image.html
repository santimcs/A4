<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Song Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%);
            min-height: 100vh;
            color: #e5e7eb;
        }
        .container {
            max-width: 900px;
        }
        .btn-primary {
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.15);
        }
        .prompt-card {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .prompt-card:hover {
            transform: scale(1.02);
            border-color: #4f46e5;
        }
        .prompt-card.selected {
            border-color: #a78bfa;
            background-color: #374151;
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.5);
        }
        .loading-indicator {
            border-top-color: #4f46e5;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-white mb-2">Song-to-Image AI Creator</h1>
            <p class="text-lg text-gray-400">Transform the feeling of a song into a stunning visual masterpiece.</p>
            <button
                id="start-over-btn"
                onclick="handleStartOver()"
                class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 hidden"
            >
                Start Over
            </button>
        </header>

        <!-- Step 1: Input and Prompt Generation -->
        <section id="step-1" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-bold mb-4 text-indigo-400">1. Describe the Song's Meaning</h2>
            <textarea
                id="song-summary"
                rows="4"
                placeholder="E.g., 'A melancholic song about a lost love, set during a rainy night in a futuristic cyberpunk city, focusing on themes of regret and glittering neon signs.'"
                class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
            ></textarea>
            <button
                id="generate-prompts-btn"
                onclick="handleGeneratePrompts()"
                class="btn-primary w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 flex items-center justify-center"
            >
                Generate 3 Image Prompts
            </button>
            <div id="status-message" class="text-center mt-3 text-sm font-medium text-red-400 hidden"></div>

            <!-- Loading Indicator -->
            <div id="loading-spinner-prompts" class="mt-4 flex justify-center hidden">
                <div class="loading-indicator w-8 h-8 border-4 border-gray-600 border-solid rounded-full"></div>
                <span class="ml-3 text-indigo-400">AI is composing prompts...</span>
            </div>
        </section>

        <!-- Step 2: Prompt Selection -->
        <section id="step-2" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 hidden">
            <h2 class="text-2xl font-bold mb-4 text-purple-400">2. Select Your Favorite Prompt</h2>
            <div id="prompts-container" class="space-y-4">
                <!-- Prompts will be dynamically inserted here -->
            </div>
            <button
                id="generate-image-btn"
                onclick="handleGenerateImage()"
                disabled
                class="btn-primary w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
            >
                Generate Image (640x480)
            </button>

             <!-- Loading Indicator for Image -->
            <div id="loading-spinner-image" class="mt-4 flex justify-center hidden">
                <div class="loading-indicator w-8 h-8 border-4 border-gray-600 border-solid rounded-full"></div>
                <span class="ml-3 text-purple-400">AI is painting the masterpiece...</span>
            </div>
        </section>

        <!-- Step 3: Image Output -->
        <section id="step-3" class="bg-gray-800 p-6 rounded-xl shadow-2xl hidden">
            <h2 class="text-2xl font-bold mb-4 text-teal-400">3. Your Generated Image</h2>
            <div id="image-output-container" class="flex justify-center items-center bg-gray-900 rounded-lg overflow-hidden border border-teal-500 p-2">
                <img id="generated-image" class="rounded-lg max-w-full h-auto" src="" alt="Generated image based on song prompt" style="max-height: 480px; width: 640px;" />
            </div>
        </section>

    </div>

    <script>
        // --- API Configuration ---
        const TEXT_MODEL_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        // Note: For image generation, we use the preferred Imagen model
        const IMAGE_MODEL_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict';
        const apiKey = "AIzaSyCHwaQt6SZe1adstgv4VJ453eQDnlemVBc"; // API key will be provided by the runtime

        // --- State Variables ---
        let selectedPrompt = '';

        // --- Utility Functions ---

        /**
         * Fetches data with exponential backoff for resilience against transient errors.
         * @param {string} url - The API endpoint URL.
         * @param {object} options - Fetch options (method, headers, body).
         * @param {number} maxRetries - Maximum number of retries.
         * @returns {Promise<Response>} - The successful fetch response.
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 6) {
            // Start with base options, ensuring Content-Type
            let finalOptions = { 
                ...options, 
                headers: { 
                    'Content-Type': 'application/json', 
                    ...(options.headers || {}) 
                } 
            }; 
            
            // Get the base URL path without any existing query parameters
            let fullUrl = url.split('?')[0]; 

            // Explicitly set the API key as a query parameter for all calls.
            // This is the most consistent method for the execution environment.
            fullUrl = `${fullUrl}?key=${apiKey}`;

            // Also, explicitly remove any API key header that might conflict with the query parameter method.
            if (finalOptions.headers && finalOptions.headers['X-Goog-Api-Key']) {
                delete finalOptions.headers['X-Goog-Api-Key'];
            }
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(fullUrl, finalOptions);

                    if (response.status === 429) {
                        // Rate limit exceeded, prepare to retry
                        throw new Error(`Rate limit exceeded (429). Retry attempt ${i + 1}.`);
                    }
                    if (!response.ok) {
                         const errorBody = await response.text();
                         console.error("API Error Response:", errorBody);
                         // Including full URL in error message for better debugging if necessary
                         throw new Error(`API call failed with status ${response.status} for URL: ${fullUrl.split('?')[0]}. Full details logged to console.`);
                    }
                    return response;
                } catch (error) {
                    // Do not log retries as errors in the console
                    if (i === maxRetries - 1) throw error;

                    // Exponential backoff delay (2^i seconds)
                    const delay = Math.pow(2, i) * 1000 + (Math.random() * 500); // Add jitter
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Step 1: Prompt Generation Logic ---

        async function generatePrompts(summary) {
            const systemPrompt = `You are a world-class creative director and text-to-image prompt engineer.
            Given the song summary below, generate three (3) distinct, highly detailed, and evocative prompts suitable for an advanced AI image generation model (like Imagen).
            Each prompt MUST be self-contained and specify:
            1. The core subject matter.
            2. The artistic style (e.g., hyper-realistic oil painting, retro vaporwave illustration, detailed 3D render).
            3. Specific lighting and atmosphere (e.g., volumetric god rays, dark and moody cinematic lighting).
            4. The color palette (e.g., neon purple and magenta, desaturated sepia tones).
            5. The mood/emotion (e.g., profound melancholy, triumphant joy).

            Your response MUST be a single JSON object containing an array named 'prompts'. Do not include any text or markdown outside the JSON structure.
            `;

            const payload = {
                contents: [{ parts: [{ text: systemPrompt + "\n\nSong Summary: " + summary }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            prompts: {
                                type: "ARRAY",
                                description: "An array containing three image generation prompts.",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        text: { type: "STRING", description: "The detailed image prompt." }
                                    },
                                    required: ["text"]
                                }
                            }
                        },
                        required: ["prompts"]
                    }
                }
            };

            const options = {
                method: 'POST',
                // Headers and URL are handled in exponentialBackoffFetch
                body: JSON.stringify(payload)
            };

            const response = await exponentialBackoffFetch(TEXT_MODEL_URL, options);
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (jsonText) {
                try {
                    const parsedJson = JSON.parse(jsonText);
                    if (parsedJson.prompts && Array.isArray(parsedJson.prompts)) {
                        return parsedJson.prompts.map(p => p.text);
                    } else {
                        throw new Error("Invalid prompt structure in response.");
                    }
                } catch (e) {
                    console.error("Failed to parse structured JSON response:", jsonText, e);
                    throw new Error("AI returned an invalid prompt structure.");
                }
            } else {
                throw new Error("AI did not return any text content for prompts.");
            }
        }

        function displayPrompts(prompts) {
            const container = document.getElementById('prompts-container');
            container.innerHTML = '';
            prompts.forEach((prompt, index) => {
                const card = document.createElement('div');
                card.id = `prompt-${index}`;
                card.className = 'prompt-card bg-gray-700 p-4 rounded-lg shadow-md';
                card.setAttribute('data-prompt', prompt);
                card.onclick = () => selectPrompt(card, prompt);
                card.innerHTML = `
                    <p class="font-bold text-lg text-indigo-300 mb-2">Option ${index + 1}</p>
                    <p class="text-gray-200 text-sm">${prompt}</p>
                `;
                container.appendChild(card);
            });
            document.getElementById('step-2').classList.remove('hidden');
            document.getElementById('start-over-btn').classList.remove('hidden');
        }

        function selectPrompt(card, prompt) {
            document.querySelectorAll('.prompt-card').forEach(c => {
                c.classList.remove('selected');
            });
            card.classList.add('selected');
            selectedPrompt = prompt;
            document.getElementById('generate-image-btn').disabled = false;
        }

        // --- Step 2/3: Image Generation Logic ---

        async function generateImage(prompt) {
            const payload = {
                instances: [{
                    prompt: prompt,
                }],
                parameters: {
                    "sampleCount": 1,
                    "aspectRatio": "4:3",
                    "outputMimeType": "image/jpeg"
                }
            };

            const options = {
                method: 'POST',
                // Headers and URL are handled in exponentialBackoffFetch
                body: JSON.stringify(payload)
            };

            const response = await exponentialBackoffFetch(IMAGE_MODEL_URL, options);
            const result = await response.json();

            // The Imagen API returns base64 encoded image data in result.predictions[0].bytesBase64Encoded
            const base64Data = result.predictions?.[0]?.bytesBase64Encoded;

            if (base64Data) {
                // Prepend the data URL prefix for PNG (standard Imagen output)
                return `data:image/png;base64,${base64Data}`;
            } else {
                console.error("Imagen API Response:", result);
                throw new Error("AI did not return a valid image.");
            }
        }

        function displayImage(imageUrl) {
            const imgElement = document.getElementById('generated-image');
            imgElement.src = imageUrl;
            imgElement.alt = "Generated image for prompt: " + selectedPrompt;
            document.getElementById('step-3').classList.remove('hidden');
            
            // Scroll to the image
            document.getElementById('step-3').scrollIntoView({ behavior: 'smooth' });
        }

        // --- Start Over Function ---
        function handleStartOver() {
            // Clear input fields
            document.getElementById('song-summary').value = '';
            
            // Reset state variables
            selectedPrompt = '';
            
            // Hide sections
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            
            // Clear generated content
            document.getElementById('prompts-container').innerHTML = '';
            document.getElementById('generated-image').src = '';
            
            // Reset buttons
            document.getElementById('generate-image-btn').disabled = true;
            document.getElementById('generate-prompts-btn').disabled = false;
            
            // Clear status messages
            document.getElementById('status-message').classList.add('hidden');
            
            // Hide start over button
            document.getElementById('start-over-btn').classList.add('hidden');
            
            // Focus back on the textarea for new input
            document.getElementById('song-summary').focus();
        }

        // --- UI Handlers ---

        async function handleGeneratePrompts() {
            const summary = document.getElementById('song-summary').value.trim();
            const statusDiv = document.getElementById('status-message');
            const spinner = document.getElementById('loading-spinner-prompts');
            const generateBtn = document.getElementById('generate-prompts-btn');

            statusDiv.classList.add('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');

            if (summary.length < 20) {
                statusDiv.textContent = "Please provide a more detailed summary (at least 20 characters).";
                statusDiv.classList.remove('hidden');
                return;
            }

            try {
                generateBtn.disabled = true;
                spinner.classList.remove('hidden');
                const prompts = await generatePrompts(summary);
                displayPrompts(prompts);
            } catch (error) {
                console.error("Error during prompt generation:", error);
                statusDiv.textContent = `Error: ${error.message}. Please try again.`;
                statusDiv.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

        async function handleGenerateImage() {
            if (!selectedPrompt) {
                document.getElementById('status-message').textContent = "Please select one of the generated prompts first.";
                document.getElementById('status-message').classList.remove('hidden');
                return;
            }

            const statusDiv = document.getElementById('status-message');
            const spinner = document.getElementById('loading-spinner-image');
            const generateBtn = document.getElementById('generate-image-btn');
            
            statusDiv.classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');

            try {
                spinner.classList.remove('hidden');
                generateBtn.disabled = true;
                const imageUrl = await generateImage(selectedPrompt);
                displayImage(imageUrl);
            } catch (error) {
                console.error("Error during image generation:", error);
                statusDiv.textContent = `Error generating image: ${error.message}. Please check console for details.`;
                statusDiv.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

    </script>
</body>
</html>